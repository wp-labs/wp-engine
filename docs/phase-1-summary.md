# é˜¶æ®µ 1 å®Œæˆæ€»ç»“

**æ—¥æœŸ**: 2026-01-10
**é˜¶æ®µ**: ç»Ÿä¸€å‚æ•°åˆå¹¶é€»è¾‘

---

## ç›®æ ‡

æ¶ˆé™¤ CLI å±‚ä¸­é‡å¤çš„å‚æ•°åˆå¹¶ä»£ç ï¼Œç»Ÿä¸€åˆ°å•ä¸€å®ç°ã€‚

---

## å®Œæˆå†…å®¹

### 1. æ–°å¢æ–‡ä»¶

**`crates/wp-config/src/connectors/params.rs`** (çº¦ 200 è¡Œ)
- ç»Ÿä¸€çš„ `merge_params()` å‡½æ•°å®ç°
- å®Œæ•´çš„æ–‡æ¡£æ³¨é‡Šå’Œä½¿ç”¨ç¤ºä¾‹
- 6 ä¸ªå•å…ƒæµ‹è¯•ç”¨ä¾‹è¦†ç›–æ‰€æœ‰åœºæ™¯ï¼š
  - ç™½åå•å‚æ•°è¦†ç›–éªŒè¯
  - æ‹’ç»éç™½åå•å‚æ•°
  - å‚æ•°å€¼è¦†ç›–
  - ç©ºè¦†ç›–å‚æ•°å¤„ç†
  - å¤šä¸ªå‚æ•°è¦†ç›–
  - ä¿ç•™åŸºç¡€å‚æ•°

### 2. ä¿®æ”¹æ–‡ä»¶

**`crates/wp-config/src/connectors/mod.rs`**
- æ·»åŠ  `mod params;` æ¨¡å—å£°æ˜
- å¯¼å‡º `pub use params::merge_params;`

**`crates/wp-cli-core/src/connectors/sources.rs`**
- åˆ é™¤æœ¬åœ° `merge_params` å®ç°ï¼ˆ15 è¡Œï¼‰
- æ·»åŠ  `use wp_conf::connectors::merge_params;`
- ç§»é™¤æœªä½¿ç”¨çš„ `ToStructError` å¯¼å…¥
- ä½¿ç”¨ç»Ÿä¸€å®ç°ï¼Œä¿æŒåŠŸèƒ½ä¸å˜

**`crates/wp-cli-utils/src/sources.rs`**
- åˆ é™¤æœ¬åœ° `merge_params` å®ç°ï¼ˆ9 è¡Œï¼‰
- æ·»åŠ  `use wp_conf::connectors::merge_params;`
- æ–°å¢è¾…åŠ©å‡½æ•° `toml_table_to_param_map` ç”¨äºç±»å‹è½¬æ¢
- æ›´æ–° 2 å¤„è°ƒç”¨ç‚¹ï¼š
  - `total_input_from_wpsrc()` å‡½æ•°ï¼ˆç¬¬ 86 è¡Œï¼‰
  - `list_file_sources_with_lines()` å‡½æ•°ï¼ˆç¬¬ 177 è¡Œï¼‰
- ä½¿ç”¨ `unwrap_or_else` æä¾›å‘åå…¼å®¹çš„é”™è¯¯å¤„ç†

**`docs/refactor-checklist.md`**
- æ ‡è®°é˜¶æ®µ 1 æ‰€æœ‰ä»»åŠ¡ä¸ºå®Œæˆ
- æ›´æ–°é‡Œç¨‹ç¢‘çŠ¶æ€
- æ›´æ–°é¡¹ç›®çŠ¶æ€

### 3. ä»£ç æŒ‡æ ‡

- **åˆ é™¤é‡å¤ä»£ç **: 24 è¡Œ (15 + 9)
- **æ–°å¢ä»£ç **: ~200 è¡Œï¼ˆåŒ…å«å®Œæ•´æµ‹è¯•å’Œæ–‡æ¡£ï¼‰
- **æµ‹è¯•è¦†ç›–**: æ–°å¢ 6 ä¸ªå•å…ƒæµ‹è¯•
- **å‡€æ•ˆæœ**: æ¶ˆé™¤äº†é€»è¾‘é‡å¤ï¼Œæå‡äº†å¯ç»´æŠ¤æ€§

---

## æµ‹è¯•éªŒè¯

### æµ‹è¯•ç»“æœ

```
âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡: 911 tests
âœ… æ— ç¼–è¯‘è­¦å‘Š
âœ… æ— ç¼–è¯‘é”™è¯¯
```

### æµ‹è¯•åˆ†è§£

- **orion-exp**: 9 tests âœ…
- **wp-cli-core**: 10 tests âœ…
- **wp-cli-core é›†æˆæµ‹è¯•**: 11 tests âœ…
  - integration_sinks_validation: 6 tests
  - integration_stat_sources: 5 tests
- **wp-cli-utils**: 12 tests âœ…
- **wp-config**: 44 tests âœ…
  - åŒ…å«æ–°å¢çš„ 6 ä¸ª params æ¨¡å—æµ‹è¯•
- **wp-engine**: 217 tests âœ…
- **å…¶ä»–é›†æˆæµ‹è¯•**: 608 tests âœ…

---

## æ”¶ç›Šåˆ†æ

### å³æ—¶æ”¶ç›Š

1. **ä»£ç é‡å¤æ¶ˆé™¤**
   - ä» 3 å¤„é‡å¤å®ç° â†’ 1 å¤„ç»Ÿä¸€å®ç°
   - CLI å±‚å®Œå…¨ç»Ÿä¸€å‚æ•°åˆå¹¶é€»è¾‘

2. **é”™è¯¯å¤„ç†ä¸€è‡´æ€§**
   - ç»Ÿä¸€çš„é”™è¯¯ä¿¡æ¯æ ¼å¼
   - ç»Ÿä¸€çš„ç™½åå•éªŒè¯é€»è¾‘
   - æ›´æ¸…æ™°çš„é”™è¯¯æç¤º

3. **å¯æµ‹è¯•æ€§æå‡**
   - å•ä¸€æµ‹è¯•ç‚¹è¦†ç›–æ‰€æœ‰åœºæ™¯
   - 6 ä¸ªä¸“é—¨æµ‹è¯•ç”¨ä¾‹
   - æ›´å®¹æ˜“æ·»åŠ æ–°çš„è¾¹ç•Œæµ‹è¯•

4. **ä»£ç å¯è¯»æ€§**
   - å®Œæ•´çš„æ–‡æ¡£æ³¨é‡Š
   - æ¸…æ™°çš„ä½¿ç”¨ç¤ºä¾‹
   - æ˜ç¡®çš„å‚æ•°è¯­ä¹‰

### é•¿æœŸæ”¶ç›Š

1. **ç»´æŠ¤æˆæœ¬é™ä½**
   - ä¿®æ”¹åªéœ€ä¸€å¤„
   - å‡å°‘ä¸ä¸€è‡´é£é™©
   - æ›´å®¹æ˜“ç†è§£ä»£ç 

2. **å¯é æ€§æå‡**
   - å•ä¸€çœŸå®æ¥æº
   - ç»Ÿä¸€çš„éªŒè¯è§„åˆ™
   - å‡å°‘æ½œåœ¨ bug

3. **æ‰©å±•æ€§æ›´å¥½**
   - æ–°åŠŸèƒ½æ›´å®¹æ˜“æ·»åŠ 
   - æ›´å®¹æ˜“é€‚é…æ–°éœ€æ±‚
   - ä¸ºæœªæ¥ä¼˜åŒ–å¥ å®šåŸºç¡€

---

## æŠ€æœ¯è¦ç‚¹

### å‚æ•°åˆå¹¶è¯­ä¹‰

ç»Ÿä¸€çš„ `merge_params` å‡½æ•°å®ç°ä»¥ä¸‹è¯­ä¹‰ï¼š

1. **åŸºç¡€å‚æ•°ä¿ç•™**: æ‰€æœ‰åŸºç¡€å‚æ•°éƒ½ä¼šä¿ç•™
2. **ç™½åå•éªŒè¯**: åªæœ‰åœ¨ç™½åå•ä¸­çš„å‚æ•°æ‰èƒ½è¢«è¦†ç›–
3. **è¦†ç›–ä¼˜å…ˆ**: è¦†ç›–å‚æ•°ä¼šæ›¿æ¢åŒååŸºç¡€å‚æ•°
4. **é”™è¯¯è¿”å›**: éç™½åå•å‚æ•°ä¼šè¿”å›æ˜ç¡®çš„é”™è¯¯ä¿¡æ¯

### ç±»å‹è½¬æ¢ç­–ç•¥

ä¸ºäº†å…¼å®¹ä¸åŒè°ƒç”¨åœºæ™¯ï¼Œæä¾›äº†è¾…åŠ©å‡½æ•°ï¼š

```rust
// wp-cli-utils/sources.rs
fn toml_table_to_param_map(table: &toml::value::Table) -> ParamMap {
    table.iter()
        .map(|(k, v)| (k.clone(), param_value_from_toml(v)))
        .collect()
}
```

è¿™å…è®¸ä» TOML è¡¨ç›´æ¥è½¬æ¢ä¸º ParamMapã€‚

### å‘åå…¼å®¹å¤„ç†

åœ¨ wp-cli-utils ä¸­ä½¿ç”¨ `unwrap_or_else` æä¾›é™é»˜å¤±è´¥ï¼š

```rust
let merged = merge_params(&conn.default_params, &ov_map, &conn.allow_override)
    .unwrap_or_else(|_| conn.default_params.clone());
```

è¿™ä¿æŒäº†ä¸æ—§è¡Œä¸ºçš„å…¼å®¹æ€§ï¼ˆé™é»˜å¿½ç•¥é”™è¯¯ï¼‰ã€‚

---

## å‘ç°çš„å…¶ä»–å®ç°

åœ¨æ£€æŸ¥è¿‡ç¨‹ä¸­å‘ç°ä»¥ä¸‹ç±»ä¼¼å®ç°ï¼Œä½†ä¿ç•™ä¸å˜ï¼ˆæœ‰å……åˆ†ç†ç”±ï¼‰ï¼š

1. **`wp-config/src/sources/build.rs:40`** - `merge_source_params`
   - åŠŸèƒ½: æºé…ç½®æ„å»ºæ—¶çš„å‚æ•°åˆå¹¶
   - ç‰¹ç‚¹: åŒ…å«åµŒå¥—å­—æ®µé»‘åå•éªŒè¯
   - ä¿ç•™åŸå› : å±äºé…ç½®å±‚å†…éƒ¨å®ç°ï¼Œæœ‰é¢å¤–çš„é¢†åŸŸç‰¹å®šéªŒè¯

2. **`wp-config/src/sinks/build.rs:118`** - `merge_params_with_allowlist`
   - åŠŸèƒ½: Sink é…ç½®æ„å»ºæ—¶çš„å‚æ•°åˆå¹¶
   - ç‰¹ç‚¹: åŒ…å«åµŒå¥—å­—æ®µé»‘åå•éªŒè¯ + è¯¦ç»†é”™è¯¯ä¸Šä¸‹æ–‡
   - ä¿ç•™åŸå› : å±äºé…ç½®å±‚å†…éƒ¨å®ç°ï¼Œæœ‰ sink ç‰¹å®šçš„éªŒè¯é€»è¾‘

**è¯´æ˜**: è¿™äº›å‡½æ•°æ˜¯åŸºç¡€è®¾æ–½å±‚çš„å®ç°ï¼Œä¸ CLI å±‚çš„å‚æ•°åˆå¹¶è¯­ä¹‰ä¸åŒã€‚æœªæ¥å¯ä»¥è€ƒè™‘è®©å®ƒä»¬å¤ç”¨ç»Ÿä¸€çš„ `merge_params` ä½œä¸ºåŸºç¡€ï¼Œä½†è¿™è¶…å‡ºäº†é˜¶æ®µ 1 çš„èŒƒå›´ã€‚

---

## é£é™©è¯„ä¼°

### é£é™©ç­‰çº§: ğŸŸ¢ ä½

- **å½±å“èŒƒå›´**: ä»…é™å‚æ•°åˆå¹¶é€»è¾‘ï¼Œæ ¸å¿ƒåŠŸèƒ½æœªæ”¹å˜
- **å›æ»šéš¾åº¦**: å®¹æ˜“ï¼ˆå•æ¬¡æäº¤ï¼‰
- **æµ‹è¯•è¦†ç›–**: å®Œæ•´ï¼ˆ911 tests all passï¼‰
- **ç ´åæ€§å˜æ›´**: æ— 

### å…¼å®¹æ€§

- âœ… API ä¿æŒä¸å˜
- âœ… è¡Œä¸ºä¿æŒä¸€è‡´
- âœ… é”™è¯¯å¤„ç†å¢å¼ºï¼ˆæ›´æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯ï¼‰
- âœ… å‘åå…¼å®¹

---

## é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

### é—®é¢˜ 1: ç±»å‹ä¸åŒ¹é…

**é—®é¢˜**: wp-cli-utils ä¸­çš„æœ¬åœ°å®ç°æ¥å— `&toml::value::Table`ï¼Œè€Œç»Ÿä¸€å®ç°æ¥å— `&ParamMap`

**è§£å†³æ–¹æ¡ˆ**: æ·»åŠ è½¬æ¢è¾…åŠ©å‡½æ•° `toml_table_to_param_map`

### é—®é¢˜ 2: é”™è¯¯å¤„ç†å·®å¼‚

**é—®é¢˜**: æ—§å®ç°é™é»˜å¿½ç•¥éç™½åå•å‚æ•°ï¼Œæ–°å®ç°è¿”å›é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**: åœ¨è°ƒç”¨ç‚¹ä½¿ç”¨ `unwrap_or_else` ä¿æŒå‘åå…¼å®¹

### é—®é¢˜ 3: ç¼–è¯‘è­¦å‘Š

**é—®é¢˜**: `ToStructError` å¯¼å…¥æœªä½¿ç”¨

**è§£å†³æ–¹æ¡ˆ**: ç§»é™¤æœªä½¿ç”¨çš„å¯¼å…¥

---

## ä¸‹ä¸€æ­¥

å‡†å¤‡è¿›å…¥**é˜¶æ®µ 2: ç§»é™¤ä¸šåŠ¡é€»è¾‘ä¸‹æ²‰**

### é˜¶æ®µ 2 é¢„è§ˆ

**ç›®æ ‡**: å°† wp-cli-utils ä¸­çš„ä¸šåŠ¡é€»è¾‘ç§»åˆ° wp-cli-core

**ä¸»è¦ä»»åŠ¡**:
1. åœ¨ `wp-cli-core/src/business/` åˆ›å»º `observability` æ¨¡å—
2. å°† `wp-cli-utils/sources.rs` ä¸­çš„ä¸šåŠ¡å‡½æ•°ç§»åˆ° core
   - `list_file_sources_with_lines()`
   - `total_input_from_wpsrc()`
3. æ›´æ–°è°ƒç”¨ç‚¹
4. ç§»é™¤ utils å±‚çš„ä¸šåŠ¡ä»£ç 

**é¢„è®¡æ—¶é—´**: 1-2 å°æ—¶
**é£é™©ç­‰çº§**: ğŸŸ¡ ä¸­ç­‰

---

## é™„å½•

### æäº¤ä¿¡æ¯æ¨¡æ¿

```
refactor(phase-1): unify parameter merging logic

## é˜¶æ®µ 1 å®Œæˆå†…å®¹

### æ ¸å¿ƒæ”¹è¿›
- åˆ›å»ºç»Ÿä¸€çš„å‚æ•°åˆå¹¶å‡½æ•° wp-config::connectors::merge_params()
- æ¶ˆé™¤ 2 å¤„ CLI å±‚é‡å¤å®ç°
- ç»Ÿä¸€é”™è¯¯å¤„ç†å’ŒéªŒè¯é€»è¾‘

### æ–°å¢
- crates/wp-config/src/connectors/params.rs
  - merge_params() ç»Ÿä¸€å®ç°
  - 6 ä¸ªå•å…ƒæµ‹è¯•è¦†ç›–å„ç§åœºæ™¯
  - å®Œæ•´çš„æ–‡æ¡£æ³¨é‡Š

### ä¿®æ”¹
- crates/wp-config/src/connectors/mod.rs
  - å¯¼å‡º merge_params å‡½æ•°

- crates/wp-cli-core/src/connectors/sources.rs
  - åˆ é™¤æœ¬åœ° merge_params (15 è¡Œ)
  - ä½¿ç”¨ç»Ÿä¸€å®ç°
  - ç§»é™¤æœªä½¿ç”¨å¯¼å…¥

- crates/wp-cli-utils/src/sources.rs
  - åˆ é™¤æœ¬åœ° merge_params (9 è¡Œ)
  - æ·»åŠ  toml_table_to_param_map è¾…åŠ©å‡½æ•°
  - æ›´æ–° 2 å¤„è°ƒç”¨ç‚¹

### éªŒè¯
- âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡ (911 tests)
- âœ… æ— ç¼–è¯‘è­¦å‘Š
- âœ… è¡Œä¸ºä¿æŒä¸€è‡´

### æ”¶ç›Š
- ä»£ç é‡å¤: 3 å¤„ â†’ 1 å¤„
- åˆ é™¤é‡å¤ä»£ç : 24 è¡Œ
- é”™è¯¯å¤„ç†ç»Ÿä¸€
- ç»´æŠ¤æˆæœ¬é™ä½

Refs: #refactor/simplify-cli-architecture
Next: Phase 2 - Remove business logic from utils layer
```

---

**å®Œæˆæ—¶é—´**: 2026-01-10
**è´Ÿè´£äºº**: -
**å®¡æŸ¥çŠ¶æ€**: å¾…å®¡æŸ¥
