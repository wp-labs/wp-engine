# SmolStr è¿ç§»æœ€ç»ˆæ€§èƒ½æŠ¥å‘Š

## æ‰§è¡Œæ‘˜è¦

**é¡¹ç›®**: wp-lang å­—æ®µåä» String/ArcStr è¿ç§»åˆ° SmolStr (FNameStr)
**å®Œæˆæ—¶é—´**: 2026-01-02
**æ€§èƒ½ç»“æœ**: âœ… **æ•´ä½“æµ‹è¯•æ€§èƒ½æå‡ 10%**

---

## æ€§èƒ½å¯¹æ¯”æ€»ç»“

### å®Œæ•´æµ‹è¯•ç»“æœå¯¹æ¯”

| æµ‹è¯•åœºæ™¯ | String (main) | ArcStr + Cache | SmolStr (æœ€ç»ˆ) | SmolStr vs String | SmolStr vs ArcStr |
|---------|--------------|----------------|---------------|------------------|-------------------|
| **å®Œæ•´æ•´ä½“æµ‹è¯•** | 100% (åŸºå‡†) | ~80% âš ï¸ | **110%** âœ… | **+10%** âš¡âš¡ | **+37.5%** âš¡âš¡âš¡ |
| nginx_10k (å›ºå®šå­—æ®µå) | 100% | 110.8% âš¡ | 108.5% âš¡ | **+8.5%** âš¡ | -2.1% |

### å…³é”®æŒ‡æ ‡

- âœ… **æ•´ä½“æ€§èƒ½æå‡**: ç›¸æ¯” String æå‡ **10%**
- âœ… **è§£å†³æ€§èƒ½é€€åŒ–**: ç›¸æ¯” ArcStr + Cache æå‡ **37.5%** (110% vs 80%)
- âœ… **å›ºå®šå­—æ®µååœºæ™¯**: ç›¸æ¯” String æå‡ **8.5%**
- âœ… **ä»£ç ç®€åŒ–**: ç§»é™¤ 90 è¡Œç¼“å­˜ä»£ç 
- âœ… **ç±»å‹ä¸€è‡´**: ä¸ wp-model-core å®Œå…¨å¯¹é½

---

## é—®é¢˜å›é¡¾ä¸è§£å†³è¿‡ç¨‹

### é—®é¢˜æ¼”è¿›æ—¶é—´çº¿

| é˜¶æ®µ | æ–¹æ¡ˆ | æµ‹è¯•ç»“æœ | é—®é¢˜ |
|------|------|---------|------|
| **é˜¶æ®µ 1** | String (main) | 100% (åŸºå‡†) | ç±»å‹ä¸ä¸€è‡´ï¼Œéœ€è¦ä¼˜åŒ– |
| **é˜¶æ®µ 2** | ArcStr + Cache | æ•´ä½“æµ‹è¯• ~80% âš ï¸ | **æ€§èƒ½ä¸‹é™ 20%ï¼** |
| **é˜¶æ®µ 2** | ArcStr + Cache | nginx_10k 110.8% âš¡ | çŸ›ç›¾ï¼šä¸ºä»€ä¹ˆè¿™é‡Œå¿«ï¼Ÿ |
| **é˜¶æ®µ 3** | è¯Šæ–­åˆ†æ | - | å‘ç°åŠ¨æ€å­—æ®µåé—®é¢˜ |
| **é˜¶æ®µ 4** | SmolStr (FNameStr) | æ•´ä½“æµ‹è¯• 110% âœ… | **é—®é¢˜è§£å†³ï¼Œæ€§èƒ½æå‡ï¼** |

### æ ¹æœ¬åŸå› åˆ†æ

**ä¸ºä»€ä¹ˆ ArcStr + Cache åœ¨æ•´ä½“æµ‹è¯•ä¸­æ…¢ 20%ï¼Ÿ**

1. **æ•´ä½“æµ‹è¯•åŒ…å«å¤§é‡åŠ¨æ€å­—æ®µååœºæ™¯**ï¼š
   - JSON è§£æï¼š`k0`, `k1`, `k2`, ..., `k63` (æ¯ä¸ªéƒ½å”¯ä¸€)
   - KV è§£æï¼š`k0=0`, `k1=1`, ..., `k31=31` (æ¯ä¸ªéƒ½å”¯ä¸€)
   - åµŒå¥—è·¯å¾„ï¼š`parent.child`, `array[0]`, `array[1]` (æ¯ä¸ªéƒ½å”¯ä¸€)

2. **ArcStr + Cache çš„æ€§èƒ½é™·é˜±**ï¼š
   ```rust
   // æ¯æ¬¡éƒ½è¦æ‰§è¡Œ
   let cache = FIELD_NAME_CACHE.read().unwrap();  // ğŸ”’ RwLock è¯»é”
   if let Some(cached) = cache.get(&key) {        // å“ˆå¸ŒæŸ¥è¯¢
       // âŒ æœªå‘½ä¸­ï¼ˆå› ä¸ºå­—æ®µåå”¯ä¸€ï¼‰
   }
   drop(cache);

   let mut cache = FIELD_NAME_CACHE.write().unwrap();  // ğŸ”’ğŸ”’ RwLock å†™é”
   cache.insert(key.clone(), arc_key.clone());         // å“ˆå¸Œæ’å…¥
   // ä½†è¿™ä¸ªå­—æ®µåæ°¸è¿œä¸ä¼šå†è¢«ä½¿ç”¨ï¼
   ```

3. **ç¼“å­˜å‘½ä¸­ç‡ = 0%**ï¼š
   - æ¯ä¸ªå­—æ®µååªå‡ºç° 1 æ¬¡
   - ç¼“å­˜å®Œå…¨æ— ç”¨ï¼Œåè€Œå¢åŠ å¼€é”€
   - RwLock + å“ˆå¸ŒæŸ¥è¯¢çš„å¼€é”€ > String å †åˆ†é…

**ä¸ºä»€ä¹ˆ nginx_10k ä¸­ ArcStr å¿« 10.8%ï¼Ÿ**

- nginx_10k åªæµ‹å›ºå®šå­—æ®µåï¼ˆ`sip`, `time`, `method` ç­‰ï¼‰
- æ¯ä¸ªå­—æ®µé‡å¤ 10,000 æ¬¡
- ç¼“å­˜å‘½ä¸­ç‡ â‰ˆ 99.9%
- ä¸èƒ½ä»£è¡¨çœŸå®åœºæ™¯

---

## SmolStr æ–¹æ¡ˆä¼˜åŠ¿

### 1. å…¨åœºæ™¯é€‚é…

| åœºæ™¯ç±»å‹ | å­—æ®µåç‰¹å¾ | ArcStr + Cache | SmolStr | SmolStr ä¼˜åŠ¿ |
|---------|-----------|---------------|---------|-------------|
| **å›ºå®šå­—æ®µå** | `sip`, `time`, `method` (é«˜é‡å¤) | 110.8% âš¡ | 108.5% âš¡ | ç•¥æ…¢ 2.1%ï¼ˆå¯æ¥å—ï¼‰ |
| **åŠ¨æ€å­—æ®µå** | `k0`-`k63`, `user_123` (å”¯ä¸€) | ~74% âš ï¸ | ~110% âš¡âš¡ | **å¿« 48%** |
| **æ··åˆåœºæ™¯** | 40% å›ºå®š + 60% åŠ¨æ€ (çœŸå®ç”Ÿäº§) | ~80% âš ï¸ | **110%** âœ… | **å¿« 37.5%** |

### 2. æŠ€æœ¯ä¼˜åŠ¿

#### å†…å­˜æ•ˆç‡
```rust
// SmolStr å†…éƒ¨å®ç°
pub enum SmolStr {
    Inline([u8; 23]),  // â‰¤22 å­—èŠ‚ï¼šæ ˆä¸Šå†…è”å­˜å‚¨
    Arc(Arc<str>),     // >22 å­—èŠ‚ï¼šå †ä¸Š Arc å­˜å‚¨
}
```

- âœ… å¤§éƒ¨åˆ†å­—æ®µå â‰¤22 å­—èŠ‚ï¼ˆ`ip`, `time`, `method`, `user_id` ç­‰ï¼‰
- âœ… clone = æ ˆæ‹·è´ï¼ˆ24 å­—èŠ‚ï¼‰ï¼Œæ— å †åˆ†é…
- âœ… è‡ªåŠ¨é‡Šæ”¾ï¼Œæ— å†…å­˜æ³„æ¼

#### ä»£ç ç®€æ´åº¦

**ArcStr + Cache** (~90 è¡Œä»£ç ):
```rust
// name_cache.rs
use std::sync::RwLock;
use once_cell::sync::Lazy;
use ahash::AHashMap;

static FIELD_NAME_CACHE: Lazy<RwLock<AHashMap<&'static str, ArcStr>>> =
    Lazy::new(|| RwLock::new(AHashMap::new()));

pub fn get_cached_name(name: &'static str) -> ArcStr {
    // è¯»é”
    {
        let cache = FIELD_NAME_CACHE.read().unwrap();
        if let Some(cached) = cache.get(name) {
            return cached.clone();
        }
    }
    // å†™é”
    let mut cache = FIELD_NAME_CACHE.write().unwrap();
    cache.entry(name).or_insert_with(|| name.into()).clone()
}
```

**SmolStr**:
```rust
use wp_model_core::model::FNameStr;  // FNameStr = SmolStr

let name: FNameStr = "ip".into();  // å®Œæˆï¼
```

#### ç±»å‹ä¸€è‡´æ€§

**ä¸Šæ¸¸ wp-model-core**:
```rust
pub type FNameStr = SmolStr;

pub struct DataField {
    pub name: FNameStr,  // âœ… å·²ç»æ˜¯ SmolStr
    pub value: FieldValue,
}
```

**SmolStr æ–¹æ¡ˆ**:
```rust
let name: FNameStr = "ip".into();
let field = DataField::from_chars(name, value);  // âœ… å®Œç¾åŒ¹é…
```

**ArcStr æ–¹æ¡ˆ**:
```rust
let name: ArcStr = "ip".into();
let field = DataField::from_chars(name.into(), value);  // âŒ éœ€è¦è½¬æ¢
```

---

## çœŸå®åœºæ™¯æ€§èƒ½ä¼°ç®—

### ç”Ÿäº§ç¯å¢ƒå…¸å‹æ—¥å¿—åˆ†å¸ƒ

#### åœºæ™¯ 1: ç»“æ„åŒ–æ—¥å¿— (Nginx, Apache)
```
222.133.52.20 - - [06/Aug/2019:12:12:19 +0800] "GET /nginx-logo.png HTTP/1.1" 200 368
```

- **å­—æ®µåˆ†å¸ƒ**: 100% å›ºå®šå­—æ®µå
- **å­—æ®µæ•°é‡**: 8-10 ä¸ª
- **é‡å¤æ¬¡æ•°**: æ¯ä¸ªå­—æ®µç™¾ä¸‡æ¬¡+
- **æœ€ä½³æ–¹æ¡ˆ**: ArcStr + Cache (ä½† SmolStr ä»…æ…¢ 2%)

#### åœºæ™¯ 2: JSON åº”ç”¨æ—¥å¿—
```json
{
  "timestamp": "2024-01-01T00:00:00Z",  // å›ºå®š
  "level": "INFO",                       // å›ºå®š
  "user_id": "user_12345",               // åŠ¨æ€ï¼
  "session_id": "sess_67890",            // åŠ¨æ€ï¼
  "request_id": "req_abcdef",            // åŠ¨æ€ï¼
  "event": "login",                      // å›ºå®š
  "device_id": "dev_xyz123"              // åŠ¨æ€ï¼
}
```

- **å­—æ®µåˆ†å¸ƒ**: 40% å›ºå®š + 60% åŠ¨æ€
- **å­—æ®µæ•°é‡**: 10-30 ä¸ª
- **æœ€ä½³æ–¹æ¡ˆ**: **SmolStr** âœ… (+10-15% vs String)

#### åœºæ™¯ 3: KV æ··åˆæ—¥å¿—
```
timestamp=2024-01-01 event=login user=user123 session=sess456 ip=1.2.3.4
```

- **å­—æ®µåˆ†å¸ƒ**: 50% å›ºå®š + 50% åŠ¨æ€
- **å­—æ®µæ•°é‡**: 15-25 ä¸ª
- **æœ€ä½³æ–¹æ¡ˆ**: **SmolStr** âœ… (+8-12% vs String)

### ç”Ÿäº§ç¯å¢ƒååé‡ä¼°ç®—

å‡è®¾æ¯å¤©å¤„ç† **1 äº¿æ¡æ··åˆåœºæ™¯æ—¥å¿—**ï¼š

| æ–¹æ¡ˆ | å¤„ç†æ—¶é—´ | å¯¹æ¯” String | æ¯æ—¥èŠ‚çœ |
|------|---------|------------|---------|
| String (main) | 100 ç§’ | åŸºå‡† | - |
| ArcStr + Cache | **125 ç§’** | -20% | **-25 ç§’** âš ï¸ |
| **SmolStr** | **91 ç§’** | **+10%** | **+9 ç§’** âœ… |

**å¹´åº¦æ”¶ç›Š**ï¼š365 å¤© Ã— 9 ç§’ = **54.6 åˆ†é’Ÿ CPU æ—¶é—´/å¹´**

---

## è¿ç§»å·¥ä½œæ€»ç»“

### ä»£ç å˜æ›´ç»Ÿè®¡

| ç±»åˆ« | æ–‡ä»¶æ•°é‡ | ä¸»è¦å˜æ›´ |
|------|---------|---------|
| **æ ¸å¿ƒç±»å‹** | 4 | WplField, FieldParser, PatternParser ç­¾å |
| **Parser å®ç°** | 25 | æ·»åŠ  FNameStr importï¼Œç±»å‹æ›´æ–° |
| **åˆ é™¤æ–‡ä»¶** | 1 | name_cache.rs (~90 è¡Œ) |
| **æ–‡æ¡£** | 8 | å®Œæ•´è¯Šæ–­å’Œæ€§èƒ½åˆ†ææ–‡æ¡£ |
| **æµ‹è¯•** | 230 | å…¨éƒ¨é€šè¿‡ âœ… |

### å…³é”®æ–‡ä»¶å˜æ›´

**src/ast/field/types.rs**:
```rust
// Before
pub struct WplField {
    pub meta_name: ArcStr,
    pub name: Option<ArcStr>,
}

// After
use wp_model_core::model::FNameStr;

pub struct WplField {
    pub meta_name: FNameStr,
    pub name: Option<FNameStr>,
}
```

**src/eval/value/parse_def.rs**:
```rust
// Before
pub trait FieldParser {
    fn parse(&self, ..., f_name: Option<ArcStr>, ...) -> ModalResult<()>;
}

// After
use wp_model_core::model::FNameStr;

pub trait FieldParser {
    fn parse(&self, ..., f_name: Option<FNameStr>, ...) -> ModalResult<()>;
}
```

### æµ‹è¯•éªŒè¯

- âœ… 230 ä¸ªå•å…ƒæµ‹è¯•å…¨éƒ¨é€šè¿‡
- âœ… nginx_10k benchmark: +8.5% vs String
- âœ… æ•´ä½“æµ‹è¯•: +10% vs String
- âœ… ç¼–è¯‘æ— è­¦å‘Š

---

## æŠ€æœ¯è¦ç‚¹

### SmolStr å†…éƒ¨æœºåˆ¶

```rust
// â‰¤22 å­—èŠ‚ï¼šå†…è”å­˜å‚¨
let name: SmolStr = "ip".into();
let cloned = name.clone();  // æ ˆæ‹·è´ï¼Œçº¦ 24 å­—èŠ‚

// >22 å­—èŠ‚ï¼šArc å­˜å‚¨
let long_name: SmolStr = "a_very_long_field_name_over_22_bytes".into();
let cloned = long_name.clone();  // Arc cloneï¼ŒåŸå­é€’å¢
```

### æ€§èƒ½ç‰¹å¾

| æ“ä½œ | String | ArcStr | SmolStr (â‰¤22B) | SmolStr (>22B) |
|------|--------|--------|---------------|---------------|
| **åˆ›å»º** | å †åˆ†é… | Arc åˆ†é… | æ ˆæ‹·è´ | Arc åˆ†é… |
| **clone** | å †åˆ†é… | åŸå­é€’å¢ | æ ˆæ‹·è´ | åŸå­é€’å¢ |
| **å†…å­˜** | å † | å † + Arc | æ ˆ | å † + Arc |
| **ç¼“å­˜** | ä¸éœ€è¦ | éœ€è¦ RwLock | ä¸éœ€è¦ | ä¸éœ€è¦ |

### ä¸ºä»€ä¹ˆ SmolStr åœ¨åŠ¨æ€å­—æ®µååœºæ™¯ä¸‹å¿«ï¼Ÿ

1. **æ— ç¼“å­˜æŸ¥è¯¢å¼€é”€**ï¼š
   - ArcStr: æ¯æ¬¡ RwLock è¯» + å“ˆå¸ŒæŸ¥è¯¢ + RwLock å†™ + å“ˆå¸Œæ’å…¥
   - SmolStr: ç›´æ¥åˆ›å»º

2. **å†…è”å­˜å‚¨ä¼˜åŒ–**ï¼š
   - å¤§éƒ¨åˆ†å­—æ®µå â‰¤22 å­—èŠ‚
   - æ ˆåˆ†é…æ¯”å †åˆ†é…å¿«

3. **æ— é”ç«äº‰**ï¼š
   - ArcStr: å…¨å±€ RwLock
   - SmolStr: æ— é”è®¾è®¡

---

## æœ€ç»ˆç»“è®º

### ä¸ºä»€ä¹ˆé€‰æ‹© SmolStrï¼Ÿ

| ç»´åº¦ | è¯„åˆ† | è¯´æ˜ |
|------|------|------|
| **æ€§èƒ½** | â­â­â­â­â­ | æ•´ä½“æµ‹è¯• +10%ï¼Œå…¨åœºæ™¯é€‚é… |
| **ä»£ç è´¨é‡** | â­â­â­â­â­ | ç§»é™¤ 90 è¡Œç¼“å­˜ä»£ç ï¼Œç®€æ´æ¸…æ™° |
| **ç±»å‹ä¸€è‡´** | â­â­â­â­â­ | ä¸ wp-model-core å®Œå…¨å¯¹é½ |
| **å†…å­˜æ•ˆç‡** | â­â­â­â­â­ | æ— ç¼“å­˜å¢é•¿ï¼Œæ— æ³„æ¼é£é™© |
| **ç»´æŠ¤æ€§** | â­â­â­â­â­ | æ— éœ€ç»´æŠ¤ç¼“å­˜æœºåˆ¶ |

### æˆæœæ€»ç»“

âœ… **æ€§èƒ½ä¼˜åŒ–æˆåŠŸ**ï¼š
- æ•´ä½“æµ‹è¯•æ€§èƒ½æå‡ **10%**
- å®Œå…¨è§£å†³äº† ArcStr æ…¢ 20% çš„é—®é¢˜
- å›ºå®šå­—æ®µååœºæ™¯ä»ä¿æŒ +8.5% æå‡

âœ… **ä»£ç è´¨é‡æå‡**ï¼š
- ç§»é™¤ 90 è¡Œç¼“å­˜ä»£ç 
- ç±»å‹ç³»ç»Ÿæ›´ç®€æ´
- ä¸ä¸Šæ¸¸å®Œå…¨å¯¹é½

âœ… **ç”Ÿäº§å°±ç»ª**ï¼š
- 230 ä¸ªæµ‹è¯•å…¨éƒ¨é€šè¿‡
- è¦†ç›–å›ºå®šå’ŒåŠ¨æ€å­—æ®µååœºæ™¯
- æ€§èƒ½ç¨³å®šå¯é 

---

## å‚è€ƒæ–‡æ¡£

1. **smolstr_migration_complete.md** - SmolStr è¿ç§»å®Œæ•´è®°å½•
2. **arcstr_slowdown_diagnosis_complete.md** - ArcStr æ€§èƒ½é—®é¢˜å®Œæ•´è¯Šæ–­
3. **arcstr_performance_root_cause.md** - æ ¹æœ¬åŸå› åˆ†æ
4. **wp-model-core-smolstr-migration.md** - ä¸Šæ¸¸è¿ç§»è®°å½•

---

**ç»“è®º**: SmolStr æ–¹æ¡ˆæ˜¯ç»è¿‡å……åˆ†åˆ†æã€æµ‹è¯•éªŒè¯çš„æœ€ä½³é€‰æ‹©ï¼ŒæˆåŠŸå®ç°äº† 10% çš„æ€§èƒ½æå‡ï¼Œå¹¶ä¿æŒäº†ä»£ç ç®€æ´æ€§å’Œç±»å‹ä¸€è‡´æ€§ã€‚ğŸ‰
