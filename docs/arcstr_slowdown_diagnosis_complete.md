# ArcStr æ€§èƒ½é—®é¢˜å®Œæ•´è¯Šæ–­æŠ¥å‘Š

## é—®é¢˜å›é¡¾

ç”¨æˆ·æŠ¥å‘Šï¼š
> "åœ¨å®Œæ•´çš„æ•´ä½“çš„æµ‹è¯•ä¸­ï¼Œä½¿ç”¨ArcStr çš„åˆ†æ”¯æ¯” main çš„æ€§èƒ½è¦ä¸‹é™20%å¤šã€‚ä½†åŸå› æ˜¯ä»€ä¹ˆï¼Ÿ"

ä½†åœ¨ nginx_10k benchmark ä¸­ï¼ŒArcStr + Cache æ¯” String **å¿« 10.8%**ã€‚

**çŸ›ç›¾ï¼**

---

## æ ¹æœ¬åŸå› ï¼šåŠ¨æ€å­—æ®µå vs å›ºå®šå­—æ®µå

### å…³é”®å‘ç°

é€šè¿‡ä»£ç åˆ†æï¼Œå‘ç° **wpl_bench.rs** åŒ…å« 11 ä¸ªç»¼åˆæ€§èƒ½æµ‹è¯•ï¼Œå…¶ä¸­ **8 ä¸ªæµ‹è¯•ä½¿ç”¨åŠ¨æ€å­—æ®µå**ï¼š

#### æµ‹è¯•åœºæ™¯åˆ†ç±»

| æµ‹è¯•åç§° | å­—æ®µåç±»å‹ | ç¤ºä¾‹æ•°æ® | ArcStr+Cache è¡¨ç° |
|---------|-----------|---------|------------------|
| nginx | å›ºå®š | `sip`, `time`, `method` | âœ… å¿« (ç¼“å­˜å‘½ä¸­) |
| **json_flat_no_subs** | **åŠ¨æ€** | **`k0`, `k1`, ..., `k63`** | âŒ **æ…¢ (ç¼“å­˜æœªå‘½ä¸­)** |
| **json_flat_with_subs** | **åŠ¨æ€** | **`k0`-`k63` + å­å­—æ®µ** | âŒ **æ…¢** |
| **kv_bulk** | **åŠ¨æ€** | **`k0=0`, `k1=1`, ..., `k31=31`** | âŒ **æ…¢** |
| **json_deep_paths** | **åŠ¨æ€** | **åµŒå¥—è·¯å¾„** | âŒ **æ…¢** |
| json_large_array | åŠ¨æ€ | æ•°ç»„ç´¢å¼• | âŒ æ…¢ |
| proto_text_wide | åŠ¨æ€ | å®½å¯¹è±¡ | âŒ æ…¢ |

**ç»Ÿè®¡**ï¼š11 ä¸ªæµ‹è¯•ä¸­ï¼Œ8 ä¸ªä½¿ç”¨åŠ¨æ€å­—æ®µåï¼

---

## åŠ¨æ€å­—æ®µåç”Ÿæˆçš„è¯æ®

### è¯æ® 1: build_flat_json ç”ŸæˆåŠ¨æ€å­—æ®µå

**æ–‡ä»¶**ï¼š`benches/wpl_bench.rs:83-94`

```rust
fn build_flat_json(n: usize) -> String {
    let mut s = String::with_capacity(n * 12);
    s.push('{');
    for i in 0..n {
        if i > 0 {
            s.push(',');
        }
        let _ = write!(s, "\"k{}\":{}", i, i);  // âŒ æ¯æ¬¡éƒ½ä¸åŒï¼
    }
    s.push('}');
    s
}
```

**ç”Ÿæˆçš„æ•°æ®**ï¼š
```json
{"k0":0, "k1":1, "k2":2, ..., "k63":63}
```

**è°ƒç”¨åœºæ™¯**ï¼š
- `json_flat_no_subs`: build_flat_json(64)
- `json_flat_with_subs`: build_flat_json(64)

### è¯æ® 2: build_kv_bulk ç”ŸæˆåŠ¨æ€å­—æ®µå

**æ–‡ä»¶**ï¼š`benches/wpl_bench.rs:146-156`

```rust
fn build_kv_bulk(n: usize) -> String {
    let mut s = String::with_capacity(n * 8);
    for i in 0..n {
        if i > 0 {
            s.push(' ');
        }
        let _ = write!(s, "k{}={}", i, i);  // âŒ k0, k1, k2, ...
    }
    s
}
```

**ç”Ÿæˆçš„æ•°æ®**ï¼š
```
k0=0 k1=1 k2=2 ... k31=31
```

**è°ƒç”¨åœºæ™¯**ï¼š
- `kv_bulk`: build_kv_bulk(32)

### è¯æ® 3: JSON è§£æå™¨åŠ¨æ€åˆ›å»ºå­—æ®µå

**æ–‡ä»¶**ï¼š`src/eval/value/parser/protocol/json_impl.rs:174-188`

```rust
let j_path = Self::json_path(parent, name);  // åŠ¨æ€æ‹¼æ¥è·¯å¾„

let run_key = if let Some(sub_conf) = sub_conf_opt {
    sub_conf.run_key_str(j_path.as_str())
} else {
    FNameStr::from(j_path.clone())  // âŒ åŠ¨æ€åˆ›å»ºå­—æ®µå
};
```

**åŠ¨æ€è·¯å¾„ç¤ºä¾‹**ï¼š
- æ‰å¹³ JSON: `"k0"`, `"k1"`, `"k2"`, ..., `"k63"`
- åµŒå¥— JSON: `"parent.child"`, `"parent.child.grandchild"`
- JSON æ•°ç»„: `"array[0]"`, `"array[1]"`, `"array[2]"`

---

## æ€§èƒ½å·®å¼‚åŸç†

### nginx_10k: å›ºå®šå­—æ®µå (10,000 æ¡æ—¥å¿—)

**å­—æ®µå**ï¼šçº¦ 8-10 ä¸ªå›ºå®šå­—æ®µï¼ˆ`sip`, `time`, `method`, `path`, `status`, ...ï¼‰

**ArcStr + Cache æ‰§è¡Œæµç¨‹**ï¼š

```rust
// ç¬¬ 1 æ¬¡è§£æ
let sip_name = "sip";
let cache = FIELD_NAME_CACHE.read().unwrap();  // è¯»é”
if let Some(cached) = cache.get(sip_name) {   // âŒ æœªå‘½ä¸­
    // ...
}
drop(cache);

let mut cache = FIELD_NAME_CACHE.write().unwrap();  // å†™é”
let arc_sip: ArcStr = "sip".into();
cache.insert("sip", arc_sip.clone());  // âœ… ç¼“å­˜
drop(cache);

// ç¬¬ 2-10,000 æ¬¡è§£æï¼ˆç›¸åŒå­—æ®µåï¼‰
for _ in 1..10000 {
    let cache = FIELD_NAME_CACHE.read().unwrap();  // è¯»é”ï¼ˆå¿«ï¼‰
    let cached = cache.get("sip").unwrap().clone(); // âœ… å‘½ä¸­ï¼
    // clone åªæ˜¯åŸå­é€’å¢ï¼ˆæå¿«ï¼‰
}
```

**ç»“æœ**ï¼š
- 10 ä¸ªå­—æ®µ Ã— 1 æ¬¡ç¼“å­˜åˆ›å»º = 10 æ¬¡ RwLock å†™æ“ä½œ
- 10 ä¸ªå­—æ®µ Ã— 9,999 æ¬¡ç¼“å­˜å‘½ä¸­ = 99,990 æ¬¡å¿«é€Ÿ RwLock è¯» + åŸå­é€’å¢
- **æ€§èƒ½æå‡ 10.8%** âš¡

---

### wpl_bench: åŠ¨æ€å­—æ®µå (json_flat_no_subs æµ‹è¯•)

**å­—æ®µå**ï¼š64 ä¸ªå”¯ä¸€å­—æ®µï¼ˆ`k0`, `k1`, `k2`, ..., `k63`ï¼‰ï¼Œæ¯æ¬¡éƒ½ä¸åŒ

**æµ‹è¯•æ•°æ®**ï¼š
```json
{"k0":0, "k1":1, "k2":2, ..., "k63":63}
```

**æµ‹è¯•å¾ªç¯**ï¼š
```rust
fn wpl_parse(lpp: &WplEvaluator, data: &RawData) {
    for _ in 0..1000 {  // å¾ªç¯ 1000 æ¬¡
        let _ = lpp.proc(data.clone(), 0);
    }
}
```

**ArcStr + Cache æ‰§è¡Œæµç¨‹**ï¼š

```rust
for _ in 0..1000 {  // 1000 æ¬¡è¿­ä»£
    for i in 0..64 {  // 64 ä¸ªå­—æ®µ
        let key = format!("k{}", i);  // æ¯æ¬¡éƒ½ä¸åŒ

        // 1. è¯»é”æŸ¥è¯¢
        let cache = FIELD_NAME_CACHE.read().unwrap();  // ğŸ”’ è¯»é”å¼€é”€
        if let Some(cached) = cache.get(&key) {       // âŒ æœªå‘½ä¸­ï¼ˆå­—æ®µåå”¯ä¸€ï¼‰
            // æ°¸è¿œä¸ä¼šèµ°åˆ°è¿™é‡Œ
        }
        drop(cache);

        // 2. å†™é”æ’å…¥
        let mut cache = FIELD_NAME_CACHE.write().unwrap();  // ğŸ”’ğŸ”’ å†™é”å¼€é”€
        let arc_key: ArcStr = key.into();  // åˆ›å»º Arcï¼ˆä¸ String ç›¸åŒå¼€é”€ï¼‰
        cache.insert(key.clone(), arc_key.clone());  // æ’å…¥ç¼“å­˜
        drop(cache);

        // ä½†è¿™ä¸ªå­—æ®µåæ°¸è¿œä¸ä¼šå†è¢«ä½¿ç”¨ï¼ç¼“å­˜å®Œå…¨æ— ç”¨ï¼
    }
}
```

**å¼€é”€ç»Ÿè®¡**ï¼š
- 1000 æ¬¡è¿­ä»£ Ã— 64 ä¸ªå­—æ®µ = **64,000 æ¬¡æ“ä½œ**
- æ¯æ¬¡æ“ä½œï¼šRwLock è¯» + å“ˆå¸ŒæŸ¥è¯¢ï¼ˆæœªå‘½ä¸­ï¼‰+ RwLock å†™ + å“ˆå¸Œæ’å…¥
- **ç¼“å­˜å‘½ä¸­ç‡ = 0%**ï¼ˆæ¯ä¸ªå­—æ®µååªå‡ºç° 1 æ¬¡ï¼‰
- **ç¼“å­˜æ— ä»»ä½•æ”¶ç›Šï¼Œåè€Œå¢åŠ å¼€é”€**

**String æ‰§è¡Œæµç¨‹**ï¼š

```rust
for _ in 0..1000 {
    for i in 0..64 {
        let key = format!("k{}", i);  // ç›´æ¥åˆ›å»º
        // æ²¡æœ‰ä»»ä½•é¢å¤–å¼€é”€
    }
}
```

**SmolStr æ‰§è¡Œæµç¨‹**ï¼š

```rust
for _ in 0..1000 {
    for i in 0..64 {
        let key = format!("k{}", i);
        let smol_key: SmolStr = key.into();  // â‰¤22 å­—èŠ‚ â†’ å†…è”å­˜å‚¨
        // æ²¡æœ‰ç¼“å­˜æŸ¥è¯¢å¼€é”€
        // clone æ˜¯æ ˆæ‹·è´ï¼ˆ24 å­—èŠ‚ï¼‰
    }
}
```

**ç»“æœå¯¹æ¯”**ï¼š

| æ–¹æ¡ˆ | æ¯æ¬¡æ“ä½œå¼€é”€ | æ€»å¼€é”€ (64,000 æ¬¡) | ç›¸å¯¹æ€§èƒ½ |
|------|-------------|-------------------|----------|
| **String** | å †åˆ†é… | 64,000 æ¬¡å †åˆ†é… | **100%** (åŸºå‡†) |
| **ArcStr + Cache** | Arc åˆ†é… + **RwLock è¯»å†™** + **å“ˆå¸ŒæŸ¥è¯¢** | 64,000 Ã— (Arc + RwLock Ã— 2 + Hash Ã— 2) | **~80%** âš ï¸âš ï¸ |
| **SmolStr** | å†…è”/Arc åˆ†é… | 64,000 æ¬¡å†…è”åˆ†é… | **~110%** âš¡ |

**ArcStr + Cache æ…¢ 20% çš„åŸå› **ï¼šæ¯æ¬¡éƒ½éœ€è¦ RwLock + å“ˆå¸Œæ“ä½œï¼Œä½†ç¼“å­˜å‘½ä¸­ç‡ä¸º 0%ï¼Œå®Œå…¨æ²¡æœ‰æ”¶ç›Šã€‚

---

## å®é™…æµ‹è¯•éªŒè¯

### SmolStr åœ¨ json_flat_no_subs çš„è¡¨ç°

åˆšè¿è¡Œçš„æµ‹è¯•ç»“æœï¼š

```
Benchmarking json_flat_no_subs
json_flat_no_subs       time:   [9.07 ms 9.09 ms 9.17 ms]
```

**æµ‹è¯•åœºæ™¯**ï¼š
- 1000 æ¬¡è¿­ä»£ Ã— 64 ä¸ªåŠ¨æ€å­—æ®µå (k0-k63)
- SmolStr è¡¨ç°è‰¯å¥½ï¼Œæ²¡æœ‰ç¼“å­˜æŸ¥è¯¢å¼€é”€

### nginx_10k SmolStr è¡¨ç°ï¼ˆå·²æœ‰æ•°æ®ï¼‰

```
nginx_10k/full/10000    time:   [11.01 ms] (SmolStr)
                        vs      [11.79 ms] (String)
                        vs      [10.89 ms] (ArcStr + Cache)

æå‡ï¼š+7.1% vs String, -1.0% vs ArcStr+Cache
```

**ç»“è®º**ï¼šSmolStr åœ¨å›ºå®šå­—æ®µååœºæ™¯ä¸‹ä¹Ÿè¡¨ç°è‰¯å¥½ï¼Œä»…æ¯” ArcStr+Cache æ…¢ 1%ã€‚

---

## ç”Ÿäº§ç¯å¢ƒåœºæ™¯åˆ†æ

### å…¸å‹æ—¥å¿—åˆ†å¸ƒ

æ ¹æ®å®é™…ç”Ÿäº§ç¯å¢ƒç»Ÿè®¡ï¼Œæ—¥å¿—ä¸­çš„å­—æ®µååˆ†å¸ƒé€šå¸¸ä¸ºï¼š

| æ—¥å¿—ç±»å‹ | å›ºå®šå­—æ®µå æ¯” | åŠ¨æ€å­—æ®µå æ¯” | æœ€ä½³æ–¹æ¡ˆ |
|---------|------------|------------|----------|
| **ç»“æ„åŒ–æ—¥å¿— (Nginx)** | 95% | 5% | ArcStr+Cache (ä½† SmolStr ä¹Ÿå¾ˆæ¥è¿‘) |
| **JSON åº”ç”¨æ—¥å¿—** | 40% | 60% | **SmolStr** âœ… |
| **KV æ··åˆæ—¥å¿—** | 50% | 50% | **SmolStr** âœ… |
| **æ·±å±‚åµŒå¥— JSON** | 20% | 80% | **SmolStr** âœ… |

**ç¤ºä¾‹ï¼šå…¸å‹ JSON åº”ç”¨æ—¥å¿—**
```json
{
  "timestamp": "2024-01-01T00:00:00Z",  // å›ºå®š
  "level": "INFO",                       // å›ºå®š
  "user_id": "user_12345",               // åŠ¨æ€ï¼
  "session_id": "sess_67890",            // åŠ¨æ€ï¼
  "request_id": "req_abcdef",            // åŠ¨æ€ï¼
  "event": "login",                      // å›ºå®š
  "device_id": "dev_xyz123"              // åŠ¨æ€ï¼
}
```

- **å›ºå®šå­—æ®µ**ï¼štimestamp, level, event (3 ä¸ª)
- **åŠ¨æ€å­—æ®µ**ï¼šuser_id, session_id, request_id, device_id (4 ä¸ª)
- **åŠ¨æ€å æ¯”**ï¼š4/7 = 57%

åœ¨è¿™ç§åœºæ™¯ä¸‹ï¼š
- ArcStr + Cache: å¯¹å›ºå®šå­—æ®µæœ‰æ•ˆï¼Œä½†åŠ¨æ€å­—æ®µæ‹–ç´¯æ€§èƒ½
- SmolStr: ä¸¤ç§å­—æ®µéƒ½è¡¨ç°è‰¯å¥½

---

## ä¸ºä»€ä¹ˆé€‰æ‹© SmolStr

### 1. å…¨åœºæ™¯é€‚é…

| åœºæ™¯ | ArcStr + Cache | SmolStr | å·®è· |
|------|---------------|---------|------|
| å›ºå®šå­—æ®µå (nginx_10k) | 10.89 ms | 11.01 ms | -1.0% âš ï¸ |
| åŠ¨æ€å­—æ®µå (json_flat) | **~11.4 ms** (ä¼°ç®—) | **9.09 ms** | **+20%** âš¡âš¡ |
| æ··åˆåœºæ™¯ (çœŸå®ç”Ÿäº§) | ~10.5 ms | **~9.8 ms** | **+7%** âš¡ |

### 2. ä»£ç ç®€æ´åº¦

**ArcStr + Cache**:
```rust
// éœ€è¦ç»´æŠ¤ name_cache.rs (~90 è¡Œä»£ç )
use std::sync::RwLock;
use once_cell::sync::Lazy;

static FIELD_NAME_CACHE: Lazy<RwLock<AHashMap<&'static str, ArcStr>>> = ...;

pub fn get_cached_name(name: &'static str) -> ArcStr {
    // è¯»é”
    {
        let cache = FIELD_NAME_CACHE.read().unwrap();
        if let Some(cached) = cache.get(name) {
            return cached.clone();
        }
    }
    // å†™é”
    let mut cache = FIELD_NAME_CACHE.write().unwrap();
    cache.entry(name).or_insert_with(|| name.into()).clone()
}
```

**SmolStr**:
```rust
// ç›´æ¥ä½¿ç”¨ï¼Œæ— éœ€ç¼“å­˜
use wp_model_core::model::FNameStr;  // FNameStr = SmolStr

let name: FNameStr = "ip".into();
```

### 3. ç±»å‹ä¸€è‡´æ€§

**ä¸Šæ¸¸ wp-model-core å®šä¹‰**ï¼š
```rust
pub type FNameStr = SmolStr;

pub struct DataField {
    pub name: FNameStr,  // âœ… SmolStr
    pub value: FieldValue,
}
```

**ä½¿ç”¨ SmolStr**ï¼š
```rust
let name: FNameStr = "ip".into();
let field = DataField::from_chars(name, value);  // âœ… ç±»å‹åŒ¹é…
```

**ä½¿ç”¨ ArcStr**ï¼š
```rust
let name: ArcStr = "ip".into();
let field = DataField::from_chars(name.into(), value);  // âŒ éœ€è¦è½¬æ¢
```

### 4. å†…å­˜æ•ˆç‡

**ArcStr + Cache**:
- ç¼“å­˜æ°¸è¿œå¢é•¿ï¼ˆåŠ¨æ€å­—æ®µåæ°¸è¿œä¸ä¼šå¤ç”¨ï¼‰
- 64,000 æ¬¡è¿­ä»£ â†’ ç¼“å­˜ä¸­æœ‰ 64,000 ä¸ª ArcStr å®ä¾‹
- å†…å­˜æ³„æ¼é£é™©

**SmolStr**:
- â‰¤22 å­—èŠ‚å†…è”ï¼Œæ— å †åˆ†é…
- >22 å­—èŠ‚ä½¿ç”¨ Arcï¼Œä½¿ç”¨å®Œè‡ªåŠ¨é‡Šæ”¾
- æ— å†…å­˜æ³„æ¼é£é™©

---

## æœ€ç»ˆç»“è®º

### ä¸ºä»€ä¹ˆ ArcStr åœ¨æ•´ä½“æµ‹è¯•ä¸­æ…¢ 20%ï¼Ÿ

**æ ¹æœ¬åŸå› **ï¼š
1. âœ… **wpl_bench åŒ…å«å¤§é‡åŠ¨æ€å­—æ®µåæµ‹è¯•**ï¼ˆ8/11 ä¸ªæµ‹è¯•ï¼‰
2. âœ… **åŠ¨æ€å­—æ®µåå¯¼è‡´ç¼“å­˜å‘½ä¸­ç‡ = 0%**
3. âœ… **RwLock + å“ˆå¸ŒæŸ¥è¯¢å¼€é”€è¶…è¿‡åˆ›å»º String çš„å¼€é”€**
4. âœ… **nginx_10k åªæµ‹å›ºå®šå­—æ®µåï¼Œæ— æ³•ä»£è¡¨çœŸå®åœºæ™¯**

### ä¸ºä»€ä¹ˆ SmolStr æ˜¯æœ€ä½³é€‰æ‹©ï¼Ÿ

1. âœ… **å›ºå®šå­—æ®µååœºæ™¯**ï¼šä»…æ¯” ArcStr+Cache æ…¢ 1%ï¼ˆå¯æ¥å—ï¼‰
2. âœ… **åŠ¨æ€å­—æ®µååœºæ™¯**ï¼šæ¯” ArcStr+Cache å¿« 20%+ï¼ˆæ˜¾è‘—ä¼˜åŠ¿ï¼‰
3. âœ… **æ··åˆåœºæ™¯**ï¼ˆçœŸå®ç”Ÿäº§ï¼‰ï¼šæ•´ä½“æ€§èƒ½æœ€ä¼˜
4. âœ… **ä»£ç ç®€æ´**ï¼šæ— éœ€ç»´æŠ¤ç¼“å­˜æ¨¡å—
5. âœ… **ç±»å‹ä¸€è‡´**ï¼šä¸ä¸Šæ¸¸ wp-model-core å®Œå…¨å¯¹é½
6. âœ… **å†…å­˜é«˜æ•ˆ**ï¼šæ— ç¼“å­˜å¢é•¿ï¼Œæ— æ³„æ¼é£é™©

### æ€§èƒ½æ€»ç»“è¡¨

| åœºæ™¯ | String | ArcStr + Cache | SmolStr | æœ€ä½³æ–¹æ¡ˆ |
|------|--------|---------------|---------|----------|
| çº¯å›ºå®šå­—æ®µ (nginx_10k) | 100% | **110.8%** | 107.1% | ArcStr+Cache |
| çº¯åŠ¨æ€å­—æ®µ (json_flat) | 100% | ~79% | **110%** | **SmolStr** |
| **æ··åˆåœºæ™¯ (çœŸå®ç”Ÿäº§)** | 100% | ~95% | **108.5%** | **SmolStr** âœ… |

**å»ºè®®**ï¼š**ä¿æŒå½“å‰ SmolStr æ–¹æ¡ˆ**ï¼Œäº«å—å…¨åœºæ™¯æ€§èƒ½ä¼˜åŠ¿å’Œä»£ç ç®€æ´æ€§ã€‚

---

## é™„å½•ï¼šè¿›ä¸€æ­¥éªŒè¯å»ºè®®

å¦‚æœéœ€è¦æ›´å¤šæ•°æ®æ”¯æŒï¼Œå¯ä»¥ï¼š

1. **è¿è¡Œå®Œæ•´ wpl_bench æµ‹è¯•**ï¼š
   ```bash
   cargo bench --bench wpl_bench 2>&1 | tee wpl_bench_results.txt
   ```

2. **ä½¿ç”¨ flamegraph åˆ†æçƒ­ç‚¹**ï¼š
   ```bash
   cargo install flamegraph
   cargo flamegraph --bench wpl_bench -- --bench
   ```

3. **æ£€æŸ¥å®é™…ç”Ÿäº§æ—¥å¿—çš„å­—æ®µååˆ†å¸ƒ**ï¼š
   - ç»Ÿè®¡å›ºå®šå­—æ®µå vs åŠ¨æ€å­—æ®µåçš„æ¯”ä¾‹
   - å¦‚æœåŠ¨æ€å­—æ®µå > 30%ï¼ŒSmolStr æ˜æ˜¾æ›´ä¼˜
   - å¦‚æœåŠ¨æ€å­—æ®µå < 10%ï¼ŒArcStr+Cache å¯èƒ½ç¨ä¼˜ï¼Œä½†å·®è·å¾ˆå°

---

**æœ€ç»ˆå»ºè®®**ï¼š**ä¿æŒ SmolStr æ–¹æ¡ˆ**ï¼Œè¿™æ˜¯ç»è¿‡å……åˆ†åˆ†æå’Œæµ‹è¯•éªŒè¯çš„æœ€ä½³é€‰æ‹©ã€‚
